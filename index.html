<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Unlock Page</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; }
    #content { border:1px solid #ccc; padding:1rem; margin-top:1rem; display:none; }
    .status { margin-top:0.5rem; color:#555; }
  </style>
</head>
<body>
  <h1>Unlock Protected Content</h1>
  <p>Enter password:</p>
  <input id="pw" type="password" />
  <button id="go">Unlock</button>
  <p id="status" class="status"></p>

  <div id="content"></div>

  <script>
    const payload = {"salt": "81GAsgAgMvk+lvZvZ1TrWg==", "iv": "5vlYLgb0J9XHG/Tr", "tag": "HZK8LzzIvs6gLwFF1+ro6A==", "iterations": 200000, "data": "7neg6IMXudFhWGSyvAYqaSSJv/OaTsoMooBE/2gAIFUlVb6hrQurZFi4wv/Ne9uCG+UG+9h+1tldsERfqLScNfglnVeMxzIPzuA4w8PSe7744MIFC8xntvNlhY9WdHDdEfJ9FgJs"};

    function b64ToArray(b64) {
      return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    async function deriveKey(password, salt, iterations) {
      const enc = new TextEncoder();
      const passKey = await crypto.subtle.importKey('raw', enc.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey(
        {name:'PBKDF2', salt, iterations, hash:'SHA-256'},
        passKey,
        { name: 'AES-GCM', length: 256 },
        false,
        ['decrypt']
      );
    }

    async function decryptAll(password) {
      const salt = b64ToArray(payload.salt);
      const iv = b64ToArray(payload.iv);
      const tag = b64ToArray(payload.tag);
      const ct = b64ToArray(payload.data);

      const combined = new Uint8Array(ct.length + tag.length);
      combined.set(ct, 0);
      combined.set(tag, ct.length);

      const key = await deriveKey(password, salt, payload.iterations);
      try {
        const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, combined);
        const dec = new TextDecoder().decode(plainBuf);
        return dec;
      } catch (e) {
        throw new Error('Decryption failed');
      }
    }

    document.getElementById('go').addEventListener('click', async () => {
      const pw = document.getElementById('pw').value;
      document.getElementById('status').textContent = 'Trying...';
      try {
        const html = await decryptAll(pw);
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').style.display = 'block';
        document.getElementById('status').textContent = 'Unlocked.';
      } catch (err) {
        document.getElementById('status').textContent = 'Wrong password or error.';
      }
    });
  </script>
</body>
</html>
